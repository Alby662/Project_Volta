<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { title: 'Report Archive - Project Volta' }) %>

    <body>

        <div class="dashboard-container">
            <!-- Header -->
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <a href="/dashboard" style="text-decoration: none; color: inherit;">
                        <h1 style="margin: 0; font-size: 1.5rem; color: var(--primary);"><i class="fas fa-arrow-left"
                                style="font-size: 1rem;"></i> Report Archive</h1>
                    </a>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                </div>
            </header>

            <!-- Search & Filter Section -->
            <div class="card" style="margin-bottom: 2rem; align-items: flex-start; text-align: left;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-search"></i> Search & Filter</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%;">

                    <div>
                        <label style="font-weight: 500; font-size: 0.9rem;">Filename / Client</label>
                        <input type="text" id="searchQuery" class="dashboard-select" placeholder="Search by name..."
                            style="margin-bottom: 0;">
                    </div>

                    <div>
                        <label style="font-weight: 500; font-size: 0.9rem;">Report Type</label>
                        <select id="searchFolder" class="dashboard-select" style="margin-bottom: 0;">
                            <option value="">All Types</option>
                            <option value="liquid">Liquid Penetrant</option>
                            <option value="vacuum">Vacuum Box</option>
                            <option value="draining_dry">Draining & Dry</option>
                            <option value="final_dimension">Final Dimension</option>
                            <option value="hydrostatic_test">Hydrostatic</option>
                            <option value="oil_leak">Oil Leak</option>
                            <option value="pickling_passivation">Pickling & Passivation</option>
                            <option value="raw_material">Raw Material</option>
                            <option value="rf_pad_pneumatic">RF-PAD Pneumatic</option>
                            <option value="visual_examination">Visual Examination</option>
                            <option value="surface_preparation_painting">Surface Prep & Painting</option>
                        </select>
                    </div>

                    <div>
                        <label style="font-weight: 500; font-size: 0.9rem;">Start Date</label>
                        <input type="date" id="startDate" class="dashboard-select" style="margin-bottom: 0;">
                    </div>

                    <div>
                        <label style="font-weight: 500; font-size: 0.9rem;">End Date</label>
                        <input type="date" id="endDate" class="dashboard-select" style="margin-bottom: 0;">
                    </div>

                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn" onclick="searchReports()" style="width: 100%;">
                            Search <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="overflow-x: auto; width: 100%;">
                    <table style="margin: 0; border: none;">
                        <thead style="background: var(--background); border-bottom: 1px solid var(--border);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; border: none;">Filename</th>
                                <th style="padding: 1rem; text-align: left; border: none;">Type</th>
                                <th style="padding: 1rem; text-align: left; border: none;">Date</th>
                                <th style="padding: 1rem; text-align: center; border: none;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Rows will be populated here -->
                            <tr>
                                <td colspan="4"
                                    style="text-align: center; padding: 2rem; color: var(--text-muted); border: none;">
                                    Loading reports...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Preview Modal -->
        <div id="previewModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: white; margin: 2% auto; padding: 0; border-radius: 8px; width: 95%; max-width: 1400px; max-height: 96vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; background-color: #f8f9fa;">
                    <h2 style="margin: 0; color: #333;">Report Preview</h2>
                    <button onclick="closePreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                </div>
                <div id="previewContent" style="flex: 1; overflow: auto; padding: 1rem; height: 85vh; background-color: #fff;"></div>
                <div style="padding: 1rem; border-top: 1px solid #eee; text-align: right; background-color: #f8f9fa;">
                    <button class="btn" onclick="closePreview()" style="padding: 0.5rem 1rem;">Close</button>
                </div>
            </div>
        </div>

        <script>
            // Folder mapping for display
            const folderMap = {
                1: "Liquid Penetrant",
                2: "Draining & Dry",
                3: "Final Dimension",
                4: "Hydrostatic",
                5: "Penetrating Oil",
                6: "Pickling & Pass",
                7: "Raw Material",
                8: "RF Pad",
                9: "Stage",
                10: "Surface Prep",
                11: "Vacuum Box",
                12: "Visual Exam"
            };

            let isAdmin = false;

            // Check auth and role
            const token = sessionStorage.getItem("adminToken");
            if (!token) {
                window.location.href = "/admin";
            } else {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.role === 'admin') {
                        isAdmin = true;
                    }
                } catch (e) {
                    console.error("Invalid token");
                }
            }

            let allReportsCache = [];

            async function searchReports() {
                try {
                    // Fetch only if cache is empty, or force refresh if needed (can add force flag later)
                    // For now, let's always fetch to ensure up-to-date data, or just filter if we separate them.
                    // Let's stick to the current pattern: Fetch -> Filter -> Render

                    const res = await fetch('/api/saved-reports');
                    if (!res.ok) throw new Error("Failed to fetch reports");

                    const reports = await res.json();
                    allReportsCache = reports; // Store for client-side ops if needed

                    // Get Filter Values
                    const query = document.getElementById('searchQuery').value.toLowerCase();
                    const type = document.getElementById('searchFolder').value;
                    const startDateIdx = document.getElementById('startDate').value;
                    const endDateIdx = document.getElementById('endDate').value;

                    // Filter Data
                    const filteredReports = reports.filter(report => {
                        // 1. Text Search (Name, No, or ID)
                        const name = (report.reportName || '').toLowerCase();
                        const no = (report.formData?.report_no || '').toLowerCase();
                        const previewNo = (report.preview?.reportNo || '').toLowerCase();

                        const matchesText = !query ||
                            name.includes(query) ||
                            no.includes(query) ||
                            previewNo.includes(query);

                        // 2. Type Search
                        const matchesType = !type || report.reportType === type;

                        // 3. Date Search
                        let matchesDate = true;
                        if (startDateIdx || endDateIdx) {
                            const reportDate = new Date(report.createdAt).setHours(0, 0, 0, 0);

                            if (startDateIdx) {
                                const start = new Date(startDateIdx).setHours(0, 0, 0, 0);
                                if (reportDate < start) matchesDate = false;
                            }

                            if (endDateIdx) {
                                const end = new Date(endDateIdx).setHours(0, 0, 0, 0);
                                if (reportDate > end) matchesDate = false;
                            }
                        }

                        return matchesText && matchesType && matchesDate;
                    });

                    renderTable(filteredReports);

                } catch (err) {
                    console.error(err);
                    document.getElementById('reportsTableBody').innerHTML = `
          <tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--danger); border: none;">
            Error loading reports: ${err.message}
          </td></tr>
        `;
                }
            }

            function renderTable(reports) {
                const tbody = document.getElementById('reportsTableBody');

                if (reports.length === 0) {
                    tbody.innerHTML = `
          <tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted); border: none;">
            No saved reports found.
          </td></tr>
        `;
                    return;
                }

                tbody.innerHTML = reports.map(report => `
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 1rem; border: none; font-weight: 500;">
            <i class="fas fa-file-alt" style="color: var(--primary); margin-right: 0.5rem;"></i>
            ${report.formData?.report_no || report.reportName || report.preview?.reportNo || 'Draft Report'}
          </td>
          <td style="padding: 1rem; border: none; color: var(--text-muted);">
            ${getReportTypeName(report.reportType)}
          </td>
          <td style="padding: 1rem; border: none; color: var(--text-muted);">
            ${new Date(report.createdAt).toLocaleDateString()} ${new Date(report.createdAt).toLocaleTimeString()}
          </td>
          <td style="padding: 1rem; text-align: center; border: none;">
            <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem; background-color: #28a745; border-color: #28a745;" 
              onclick="previewReport('${report._id}')">
              <i class="fas fa-eye"></i> Preview
            </button>
            <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" 
              onclick="exportToPDF('${report._id}')">
              <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            ${isAdmin ? `
              <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; background-color: var(--danger); margin-left: 0.5rem;" 
                onclick="deleteReport('${report._id}')">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </td>
        </tr>
      `).join('');
            }

            function getReportTypeName(type) {
                const typeMap = {
                    'liquid': 'Liquid Penetrant Test',
                    'vacuum': 'Vacuum Box Test',
                    'draining_dry': 'Draining & Dry Test',
                    'final_dimension': 'Final Dimension Test',
                    'hydrostatic_test': 'Hydrostatic Test',
                    'oil_leak': 'Oil Leak Test',
                    'pickling_passivation': 'Pickling & Passivation',
                    'raw_material': 'Raw Material Inspection',
                    'rf_pad_pneumatic': 'RF-PAD Pneumatic Test',
                    'visual_examination': 'Visual Examination',
                    'surface_preparation_painting': 'Surface Preparation & Painting'
                };
                return typeMap[type] || type;
            }


            async function exportToPDF(reportId) {
                try {
                    // Show loading indicator
                    const exportBtn = event.target;
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                    exportBtn.disabled = true;

                    const res = await fetch(`/api/export-pdf/${reportId}`, {
                        method: 'POST'
                    });

                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report-${reportId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Show success message
                        alert('PDF exported successfully!');
                    } else {
                        const error = await res.text();
                        console.error('Export failed:', error);
                        alert('Failed to export PDF: ' + error + '\n\nCheck browser console for more details.');
                    }
                } catch (err) {
                    console.error('Network error:', err);
                    alert('Network error: ' + err.message + '\n\nCheck browser console for more details.');
                } finally {
                    // Restore button state
                    if (exportBtn) {
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                    }
                }
            }

            async function deleteReport(reportId) {
                if (!confirm("Are you sure you want to delete this report? This action cannot be undone.")) return;

                try {
                    const res = await fetch(`/api/delete-saved-report/${reportId}`, {
                        method: 'DELETE'
                    });

                    if (res.ok) {
                        alert("Report deleted successfully");
                        searchReports(); // Refresh list
                    } else {
                        const data = await res.json();
                        alert("Failed to delete: " + (data.error || "Unknown error"));
                    }
                } catch (err) {
                    alert("Network error: " + err.message);
                }
            }

            // Preview functionality
            async function previewReport(reportId) {
                try {
                    // Show loading in modal
                    const modal = document.getElementById('previewModal');
                    const content = document.getElementById('previewContent');
                    content.innerHTML = '<p style="text-align: center;">Loading preview...</p>';
                    modal.style.display = 'block';
                    
                    // Fetch report HTML content
                    const res = await fetch(`/api/report-html/${reportId}`);
                    if (!res.ok) throw new Error(`Failed to fetch report: ${res.status} ${res.statusText}`);
                    
                    const data = await res.json();
                    if (!data.html) throw new Error('No HTML content received');
                    
                    // Display the HTML content with basic styling
                    // We'll sanitize the HTML and adjust paths for proper display
                    let cleanHtml = data.html;
                    
                    // Basic sanitization - remove script tags
                    cleanHtml = cleanHtml.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
                    
                    // Adjust relative paths to absolute paths
                    cleanHtml = cleanHtml.replace(/href="\//g, 'href="/');
                    cleanHtml = cleanHtml.replace(/src="\//g, 'src="/');
                    
                    // Create a container div with scrollable content
                    content.innerHTML = `
                        <div style="width: 100%; height: 100%; overflow: auto; position: relative;">
                            ${cleanHtml}
                        </div>
                    `;
                } catch (err) {
                    console.error('Preview error:', err);
                    const content = document.getElementById('previewContent');
                    content.innerHTML = `<p style="color: red;">Error loading preview: ${err.message}</p>`;
                }
            }
            
            function closePreview() {
                const modal = document.getElementById('previewModal');
                modal.style.display = 'none';
            }
            

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('previewModal');
                if (event.target === modal) {
                    closePreview();
                }
            }
            
            // Initial load
            searchReports();
        </script>
    </body>

</html>