<!-- Back Navigation -->
<div class="report-header">
    <button class="btn-back" onclick="window.location.href='/report-catalog'">
        <i class="fas fa-arrow-left"></i> Back to Catalog
    </button>
</div>

<!-- Table Controls (to be placed above dynamic tables) -->
<div class="table-controls" id="tableControls" style="display: none;">
    <div class="control-group">
        <span class="control-label">Table Actions:</span>
        <button class="btn-icon btn-sm" type="button" onclick="addRow()">
            <i class="fas fa-plus"></i> Add Row
        </button>
        <button class="btn-icon btn-sm btn-danger" type="button" onclick="deleteLastRow()">
            <i class="fas fa-minus"></i> Delete Row
        </button>
    </div>
</div>

<!-- Footer Actions -->
<div class="footer-actions">
    <button class="btn btn-success" type="button" id="btnSave">
        <i class="fas fa-save"></i> Save to Server
    </button>
    <button class="btn btn-secondary" type="button" onclick="window.print()">
        <i class="fas fa-print"></i> Print / Save PDF
    </button>
    <button class="btn btn-secondary" type="button" onclick="window.location.href='/dashboard'">
        <i class="fas fa-home"></i> Dashboard
    </button>
</div>

<script>
    // Logo mapping logic
    const logoMap = {
        "Volta Engineering Designs Pvt. Ltd.": "/images/logo.jpg",
        "Volta Green Structures Pvt. Ltd.": "/images/volta green.png",
        "Deccan Auto Ltd.": "/images/Deccan-Auto.jpg"
    };

    function updateFromLogo() {
        const selectedLogo = document.getElementById("logoSelect").value;
        const logoImg = document.getElementById("companyLogo");
        if (logoImg) logoImg.src = selectedLogo;

        // Match company name based on selected logo
        for (const [name, logo] of Object.entries(logoMap)) {
            if (logo === selectedLogo) {
                const nameInput = document.getElementById("companyName");
                if (nameInput) nameInput.value = name;
                break;
            }
        }
    }

    function updateFromName() {
        const nameInput = document.getElementById("companyName");
        if (!nameInput) return;

        const selectedName = nameInput.value;
        const logoFile = logoMap[selectedName];

        if (logoFile) {
            const logoImg = document.getElementById("companyLogo");
            const logoSelect = document.getElementById("logoSelect");

            if (logoImg) logoImg.src = logoFile;
            if (logoSelect) logoSelect.value = logoFile;
        }
    }

    // Delete last row with confirmation
    function deleteLastRow() {
        const table = document.getElementById("mainTable");
        if (!table) return;

        const tbody = table.getElementsByTagName("tbody")[0];
        if (!tbody || tbody.rows.length <= 1) {
            alert("Cannot delete the last row!");
            return;
        }

        if (confirm("Delete the last row?")) {
            tbody.deleteRow(tbody.rows.length - 1);
        }
    }

    // Save to server with loading state
    document.addEventListener('DOMContentLoaded', function () {
        const saveBtn = document.getElementById('btnSave');
        if (saveBtn) {
            saveBtn.addEventListener('click', async function () {
                const form = document.querySelector('form');
                if (!form) {
                    alert('No form found on this page');
                    return;
                }

                const formData = new FormData(form);

                // Add report type
                const reportType = window.location.pathname.split('/').pop();
                formData.append('reportType', reportType);

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const response = await fetch('/api/save-report', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert('✅ Report saved successfully!');
                        console.log('Save result:', result);
                    } else {
                        const error = await response.text();
                        alert('❌ Failed to save report: ' + error);
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert('❌ Error saving report: ' + error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save to Server';
                }
            });
        }

        // Show table controls if mainTable exists
        const mainTable = document.getElementById('mainTable');
        if (mainTable) {
            const controls = document.getElementById('tableControls');
            if (controls) {
                controls.style.display = 'flex';
                // Insert controls before the table
                mainTable.parentNode.insertBefore(controls, mainTable);
            }
        }
    });
</script>